

# Innovative Fix: Replace ExtrudeGeometry with Manual Geometry Construction

## Root Cause (finally identified)

The "steg" (material bridge) is **not** from the outer profile sidewalls — those are being removed correctly. It's from the **cutout hole boundary sidewalls** generated by `ExtrudeGeometry`. When a circular cutout crosses the fold line, THREE.js creates sidewall triangles along the **curved hole edge** near the fold line. These curved-hole sidewalls have vertices that curve **away** from the fold line (d > 1.0), so the current `removeAllFoldEdgeSidewalls` filter (which checks `|d| < 1.0`) misses them entirely.

No amount of tolerance tuning will fix this — the problem is architectural.

## Solution: Abandon ExtrudeGeometry for Base Face

Instead of generating geometry with `ExtrudeGeometry` and then trying to surgically remove the wrong triangles, build the base face geometry **manually** with full control:

```text
Current (broken):
  ExtrudeGeometry(shape + holes)
    -> generates ALL sidewalls (outer + hole edges)
    -> try to detect & remove fold-line sidewalls (fragile)
    -> rebuild segmented sidewalls

New (deterministic):
  1. Triangulate top face (earcut, with holes)
  2. Copy + offset for bottom face
  3. Build sidewalls manually per edge segment
     - Outer profile edges: skip fold-line segments in blocked regions
     - Hole edges: skip segments near fold line
     -> No wrong geometry ever created
```

## Implementation Steps

### Step 1: New `buildBaseFaceManual()` function in `geometry.ts`

Replaces `createBaseFaceMesh` when folds with cutouts exist:

1. **Top face**: Use `THREE.ShapeUtils.triangulateShape(outerPoints, holeArrays)` (same triangulation THREE.js uses internally) to get triangulated face at z=thickness
2. **Bottom face**: Same triangles, flipped normals, at z=0
3. **Outer sidewalls**: For each outer profile edge segment, check if it overlaps a fold line's unblocked region. If not on a fold line, generate a standard quad. If on a fold line, generate quads only for `bendSegments` (unblocked intervals)
4. **Hole sidewalls**: For each hole edge segment, check if both endpoints are within a configurable distance of ANY fold line. If so, skip the quad. Otherwise, generate a standard quad

This completely eliminates `removeAllFoldEdgeSidewalls` and `buildFoldEdgeSidewalls` — both become unnecessary.

### Step 2: Update `createBaseFaceMesh` to use the new builder

Add a `foldLineInfos` parameter. When present and non-empty, use the manual builder. When absent, keep the original `ExtrudeGeometry` path (for the no-fold case, which works fine).

### Step 3: Simplify Viewer3D.tsx

Remove the separate `removeAllFoldEdgeSidewalls` and `buildFoldEdgeSidewalls` calls. Pass `foldLineInfos` directly into `createBaseFaceMesh`.

### Step 4: Clean up dead code

Remove `removeAllFoldEdgeSidewalls`, `buildFoldEdgeSidewalls`, and `computeFoldLineCutoutBlocked` (the old one, not the TD version).

## Why This Works

- **No wrong geometry is ever created** — sidewall gaps are produced by not generating quads, not by deleting triangles
- **No threshold/tolerance issues** — the decision is geometric (is this edge segment on a fold line?) not heuristic
- **Single Source of Truth preserved** — `computeFoldLineInfo` still provides `bendSegments`, used by arc, tip, AND now base-face sidewalls
- **Hole sidewalls handled correctly** — hole edge segments near the fold line are simply not generated, eliminating the curved-wall steg

## Technical Details

Key algorithm for hole sidewall filtering:

```text
For each hole polygon edge (p[i] -> p[i+1]):
  For each foldLineInfo:
    Project both endpoints to fold-line local (t, d) space
    If BOTH |d| < threshold (e.g. thickness) AND
       t is within a blocked interval:
      -> Skip this quad (it's in the cutout gap)
  Otherwise:
    -> Build normal sidewall quad
```

This is robust because it operates on the **source data** (hole polygon vertices and fold line geometry), not on triangulated output where vertex identification is unreliable.

